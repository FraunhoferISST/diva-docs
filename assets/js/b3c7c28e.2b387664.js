"use strict";(self.webpackChunkdiva_docs=self.webpackChunkdiva_docs||[]).push([[8487],{3905:function(e,t,n){n.d(t,{Zo:function(){return s},kt:function(){return u}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=a.createContext({}),p=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},s=function(e){var t=p(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,c=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),m=p(n),u=o,h=m["".concat(c,".").concat(u)]||m[u]||d[u]||i;return n?a.createElement(h,r(r({ref:t},s),{},{components:n})):a.createElement(h,r({ref:t},s))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1164:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return c},default:function(){return u},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return d}});var a=n(7462),o=n(3366),i=(n(7294),n(3905)),r=["components"],l={id:"docker",title:"Docker Deployment"},c="Docker Deployment",p={unversionedId:"Deployment/docker",id:"version-3.3.1/Deployment/docker",title:"Docker Deployment",description:"DIVA is built with a focus on scalability, modularization and expandability using a microservice architecture.",source:"@site/versioned_docs/version-3.3.1/03-Deployment/03-docker.md",sourceDirName:"03-Deployment",slug:"/Deployment/docker",permalink:"/diva-docs/docs/Deployment/docker",draft:!1,tags:[],version:"3.3.1",sidebarPosition:3,frontMatter:{id:"docker",title:"Docker Deployment"},sidebar:"divaSidebar",previous:{title:"Prerequisites",permalink:"/diva-docs/docs/Deployment/prerequisites"},next:{title:"Configuration",permalink:"/diva-docs/docs/Deployment/configuration"}},s={},d=[{value:"Environment variables",id:"environment-variables",level:2},{value:"Deployment with nginx reverse proxy",id:"deployment-with-nginx-reverse-proxy",level:2}],m={toc:d};function u(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"docker-deployment"},"Docker Deployment"),(0,i.kt)("p",null,"DIVA is built with a focus on scalability, modularization and expandability using a microservice architecture.\nOur team relies on the latest technologies for container-based development and deployment of the system using Docker.\nAll system components are containerized and have current images that are continuously built in the CI pipeline.\nIn this guide we will learn how to get DIVA running with ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose"),"."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Make sure to read the ",(0,i.kt)("a",{parentName:"p",href:"prerequisites"},"prerequisites")," to know what you need to get started with Docker and Docker Compose.\nAlso note that deployment with docker is not suitable for Production.\nNonetheless, it is convenient for local development  environment to quickly spin up most of the components like Kafka, Gateway and other services."))),(0,i.kt)("p",null,"All things related to docker are located in the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/FraunhoferISST/diva/blob/master/docker"},(0,i.kt)("inlineCode",{parentName:"a"},"docker/")),"\ndirectory. You can find this folder in the source code as well as in the release distribution.\nHere we have prepared a script which you can use to directly boot all components, with default environment setup.\nIf you need a quick start, just execute the following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# navigate to docker/ directory\ncd docker\n# spin up the system\n./up_core.sh\n")),(0,i.kt)("p",null,"The script starts all core services, profiling workflow engine, DSC and the web client application.\nIt may take some time until all components are up and running.\nBy default, the client should be available on ",(0,i.kt)("inlineCode",{parentName:"p"},"localhost:70"),"."),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Container credentials")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Bei default containers start with dummy values for credentials (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"admin admin")," for MongoDB) what is completely fine for local development environment.\nIf you plan to make DIVA available publicity through the deployment with Docker, make sure to change all sensitive data.\nRefer to the ",(0,i.kt)("a",{parentName:"p",href:"#environment-variables"},"Environment variables")," section."))),(0,i.kt)("h2",{id:"environment-variables"},"Environment variables"),(0,i.kt)("p",null,"First with the environment variables you have the possibility to propagate settings to the containers on run time.\nThe ENV's are used to configure exposed ports, Kafka topics, database connections, credentials etc.\nThis makes the deployment  of containers more flexible and provides you a way to configure the environment without potential collisions with other software on your machines."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"Ports allocation")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"DIVA components allocate many default ports like 80, 3000 or 27017.\nTo avoid potential conflicts on deployment, most of the allocated ports can be configured in ",(0,i.kt)("inlineCode",{parentName:"p"},"docker/.env")," file."))),(0,i.kt)("p",null,"All available configuration possibilities are listed in the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/FraunhoferISST/diva/blob/master/docker/.env.default"},(0,i.kt)("inlineCode",{parentName:"a"},"docker/.env.default"))," file.\nThis ENV template is used by default to boot the system with ",(0,i.kt)("inlineCode",{parentName:"p"},"up_core.sh")," script. To override default settings, create\na ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," file in the ",(0,i.kt)("inlineCode",{parentName:"p"},"docker/")," directory and copy the contents of ",(0,i.kt)("inlineCode",{parentName:"p"},".env.default")," to it. There you can adjust the deployment,\nshould change all passwords and usernames and e.g. change the port of the web application as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-env"},"WEB_CLIENT_PORT=90\n")),(0,i.kt)("p",null,"In the development environment, the configuration in ",(0,i.kt)("inlineCode",{parentName:"p"},".env.default"),' and other templates are quite sufficient and must work immediately.\nHowever, in order to make DIVA "production-ready" in Docker, we need to do some tweaks. Just follow the configuration guides for\n',(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/keycloak#configuration"},"Keycloak"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/gateway#configuration"},"API Gateway")," and ",(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/web-client#configuration"},"Web-Client"),", in that order."),(0,i.kt)("h2",{id:"deployment-with-nginx-reverse-proxy"},"Deployment with nginx reverse proxy"),(0,i.kt)("p",null,"As mentioned earlier, docker is not optimal for production deployment. However, it could be useful to quickly deliver to the world a\nDIVA instance in an experimental environment. For this purpose, we provide an example reverse proxy configuration in\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/FraunhoferISST/diva/blob/master/docker/proxy/"},(0,i.kt)("inlineCode",{parentName:"a"},"docker/proxy/"))," that allows\nto easily expose DIVA with Docker Compose."),(0,i.kt)("p",null,"This simple nginx reverse proxy configuration serves as an example of how Diva could be exposed to the world. The proxy\nconfiguration in ",(0,i.kt)("inlineCode",{parentName:"p"},"nginx.example.conf")," is minimalistic and ",(0,i.kt)("strong",{parentName:"p"},"not")," suitable for production!"),(0,i.kt)("p",null,"In general, the ",(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/web-client"},"Web client")," application and the ",(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/gateway"},"API Gateway"),"\nshould be accessible through the network behind the proxy.\nIn addition, the client needs a running ",(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/keycloak"},"Keycloak")," instance, which does not necessarily have to be delivered by the same\nreverse proxy server. So the rule is that only 3 DIVA components must be accessible over the internet - Web Client,\nKong Gateway and Keycloak. Furthermore, for the Web-Client app the access to API Gateway and Keycloak should be configured\nthrough the ",(0,i.kt)("a",{parentName:"p",href:"#environment-variables"},"environment variables")," on runtime."),(0,i.kt)("p",null,"In the following we will go through an example configuration, which must give a rough idea of how DIVA could be delivered with a secured reverse proxy server.\nTo make things look more realistic, we will not be working with ",(0,i.kt)("inlineCode",{parentName:"p"},"localhost"),". We will simply imagine the domain name ",(0,i.kt)("inlineCode",{parentName:"p"},"diva.com")," and map it to ",(0,i.kt)("inlineCode",{parentName:"p"},"localhost"),"\nin ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/hosts")," on our machine:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bashell"},"127.0.0.1 localhost diva.com\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Place your SSL certificate and key in ",(0,i.kt)("inlineCode",{parentName:"li"},"./certs"),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"Use letsencrypt, openssl or other tool of your choice. Here is a command that can quickly generate the required keys for you:"),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre"},"openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout private.key -out certificate.crt\n")))),(0,i.kt)("li",{parentName:"ol"},"Create ",(0,i.kt)("inlineCode",{parentName:"li"},"nginx.conf")," in ",(0,i.kt)("inlineCode",{parentName:"li"},"proxy/")," and copy the contents of ",(0,i.kt)("inlineCode",{parentName:"li"},"nginx.example.conf")," to it",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"In this file you can add more advanced configuration, e.g. caching.\nPlease note that your have to update the client app ENV's according to the changes in the config you made!\nIn the example configuration we instruct nginx to proxy to the underlying components like follows:"),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre",className:"language-nginx",metastring:"configuration",configuration:!0},"# API Gateaway should be accessable on https://diva.com/api/ endpoint\nlocation /api/ {\n      proxy_pass http://kong:8000/; # the requests are directed to the Kong API Gateaway container\n  }\n")),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre",className:"language-nginx",metastring:"configuration",configuration:!0},"# Keyclocak should be accessable on https://diva.com/auth/\nlocation /auth/ {\n      proxy_pass http://keycloak:8080/auth/; # the requests are directed to the Keycloak container, it could also be a URL of your own Keycloak instance\n  }\n")),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre",className:"language-nginx",metastring:"configuration",configuration:!0},"# And finally the client itself, all othe request on https://diva.com/ should go to the web app\nlocation / {\n      proxy_pass http://web-client:70;\n  }\n")))),(0,i.kt)("li",{parentName:"ol"},"Create ",(0,i.kt)("inlineCode",{parentName:"li"},".env")," in ",(0,i.kt)("inlineCode",{parentName:"li"},"proxy/")," and copy the contents from ",(0,i.kt)("inlineCode",{parentName:"li"},".env.default")," to it",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"You can choose a port for the proxy server in ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," as ",(0,i.kt)("inlineCode",{parentName:"p"},"PROXY_PORT")," with default ",(0,i.kt)("inlineCode",{parentName:"p"},"443")," value."))),(0,i.kt)("li",{parentName:"ol"},"Set Web-Client ENV's and restart container",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"Update the ",(0,i.kt)("inlineCode",{parentName:"p"},"VUE_APP_API_GATEWAY_URL")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"VUE_APP_KEYCLOAK_URL")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"docker/.env")," corresponding to your nginx configuration.\nMake sure the client can access all API endpoints and communicate with Keycloak. According to provided default configuration\nthe variables should be set for example as ",(0,i.kt)("inlineCode",{parentName:"p"},"VUE_APP_API_GATEWAY_URL=https://diva/api/")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"VUE_APP_KEYCLOAK_URL=https://diva.com/auth/")))),(0,i.kt)("li",{parentName:"ol"},"Set Keycloak ENV's and restart container (optional)",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"This step is only applicable if you do not have your own managed Keycloak instance running. In that case you have to update\nin your ",(0,i.kt)("inlineCode",{parentName:"p"},"docker/.env"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_FRONTEND_URL=https://diva.com/auth/"),"."))),(0,i.kt)("li",{parentName:"ol"},"Create Kong production config and restart container",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"In ",(0,i.kt)("inlineCode",{parentName:"p"},"core/kong-gateway")," you have to create production config (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"kong.prod.yml"),"). Your can copy the contents from\n",(0,i.kt)("inlineCode",{parentName:"p"},"core/kong-gateway/kong.production.yml")," to it, but have at least to set everywhere the correct Keycloak token issuer:"),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre"},'plugins:\n   - name: jwt-keycloak\n     config:\n       allowed_iss: [ "https://diva.com/auth/realms/my-realm" ]\n')),(0,i.kt)("p",{parentName:"blockquote"},"For more details refer to ",(0,i.kt)("a",{parentName:"p",href:"/docs/Development/Architecture/gateway"},"Kong API Gateway configuration")))),(0,i.kt)("li",{parentName:"ol"},"Make sure DIVA Core is already running",(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},"You can spin up anything needed with ",(0,i.kt)("inlineCode",{parentName:"p"},"./up_core.sh")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"docker/")))),(0,i.kt)("li",{parentName:"ol"},"Run nginx proxy server in ",(0,i.kt)("inlineCode",{parentName:"li"},"proxy/")," with:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),"On your local machine with the default nginx config the Web client is available on ",(0,i.kt)("inlineCode",{parentName:"li"},"https://diva.com/"),". Now just visit the URL,\nlog in to the application through Keycloak, and make sure... that the authentication does not work! You will probably see something like:")),(0,i.kt)("p",null,"And this is fine. Since Kong and Keycloak are running in the container in Docker and we are working with ",(0,i.kt)("inlineCode",{parentName:"p"},"diva.com")," fake domain,\nwhich maps to ",(0,i.kt)("inlineCode",{parentName:"p"},"localhost"),", Kong cannot communicate with Keycloak for authentication. In the real production environment this wouldn't be\nan issue, as Keycloak would be running on a real URL. Make sure to take a look at ",(0,i.kt)("a",{parentName:"p",href:"/docs/Deployment/Configuration#kong-gateway"},"API Gateway"),",\n",(0,i.kt)("a",{parentName:"p",href:"/docs/Deployment/Configuration#keycloak"},"Keycloak")," and ",(0,i.kt)("a",{parentName:"p",href:"/docs/Deployment/Configuration#web-client"},"Web-client")," configurations to better prepare\nDIVA for production."))}u.isMDXComponent=!0}}]);