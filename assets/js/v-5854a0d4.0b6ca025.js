(self.webpackChunkdiva_docs=self.webpackChunkdiva_docs||[]).push([[183],{1225:(e,t,n)=>{"use strict";n.r(t),n.d(t,{data:()=>a});const a={key:"v-5854a0d4",path:"/deployment/configuration.html",title:"Configuration",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"Keycloak",slug:"keycloak",children:[{level:3,title:"Environment",slug:"environment",children:[]},{level:3,title:"Realm",slug:"realm",children:[]},{level:3,title:"Authentication",slug:"authentication",children:[]},{level:3,title:"Users management",slug:"users-management",children:[]}]},{level:2,title:"Kong Gateway",slug:"kong-gateway",children:[{level:3,title:"Declarative Configuration",slug:"declarative-configuration",children:[]}]},{level:2,title:"Web client",slug:"web-client",children:[]}],filePathRelative:"deployment/configuration.md",git:{contributors:[]}}},9238:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>it});var a=n(6252);const o=(0,a.Wm)("h1",{id:"configuration"},[(0,a.Wm)("a",{class:"header-anchor",href:"#configuration"},"#"),(0,a.Uk)(" Configuration")],-1),i=(0,a.Wm)("p",null,"When building DIVA we rely on established opens source solutions for creating a scalable and transparent architecture. We try to pick the best technologies like MongoDB, Elasticsearch or Kafka and others for communication of internal components and persistent storage to focus on DIVA specific logic. Since we cannot know in which environments DIVA could be deployed, we do not want to make strict assumptions about the necessary configuration of the external software.",-1),r=(0,a.Wm)("p",null,[(0,a.Uk)("Potentially, all external components can be configured flexibly. You can deploy and scale them where and how you want. The only requirement is - our DIVA internal components still know how to connect to the external components. The whole system can be configured through the environment variables. You can customize all variables in "),(0,a.Wm)("code",null,"docker/.env"),(0,a.Uk)(". For more specific requirements, you can also set the variables for individual services. The variables are documented in corresponding README's.")],-1),s=(0,a.Wm)("p",null,"In the following we will go through the main configuration steps and learn how to best prepare DIVA for production environment.",-1),l=(0,a.Wm)("h2",{id:"keycloak"},[(0,a.Wm)("a",{class:"header-anchor",href:"#keycloak"},"#"),(0,a.Uk)(" Keycloak")],-1),c={href:"https://www.keycloak.org/",target:"_blank",rel:"noopener noreferrer"},d=(0,a.Uk)("Keycloak"),u=(0,a.Uk)(" is a popular Open Source identity and access management software. In DIVA v2.2 we integrated Keycloak to 1) reuse enterprise ready identity and user account management that Keycloak provides out of the box and 2) to open for the companies the possibility to configure more granular access and authentication flow in DIVA. In this guide we assume that you are already familiar with the basic concepts of Keycloak."),h=(0,a.Uk)("DIVA is shipped with already "),m={href:"https://github.com/FraunhoferISST/diva/blob/main/core/keycloak/default-realm.json",target:"_blank",rel:"noopener noreferrer"},p=(0,a.Uk)("preconfigured"),g=(0,a.Uk)(" Keycloak 15 instance that can be started up directly with the other components. You will find more details in the "),y=(0,a.Uk)("Docker guide"),k=(0,a.Uk)(". The provided configuration has a realm with all necessary settings to accept Web-Client connections and authorize users. Nevertheless, this configuration must be optimized for production environment to improve the security setting."),f=(0,a.uE)('<p>DIVA can also be used with own managed Keycloak instance. In this case you just have to configure <a href="#web-client">Web client</a> and <a href="#kong-gateway">API Gateway</a> to work with your Keycloak.</p><div class="custom-container warning"><p class="custom-container-title">Default realm configuration</p><p>The provided configuration is very minimal and has only a set of features required for DIVA to function properly. You have to adjust the security setting corresponding to your policies and enable further features like emailing through advanced Keycloak configuration.</p></div><h3 id="environment"><a class="header-anchor" href="#environment">#</a> Environment</h3>',3),v=(0,a.Uk)("First, Keycloak must be configured in Docker through the "),w=(0,a.Uk)("environment variables"),b=(0,a.Uk)(". To do this, we need to explicitly tell Keycloak in your "),W=(0,a.Wm)("code",null,"docker/.env",-1),A=(0,a.Uk)(" on which URL the instance is running. For example, if you plan to deploy Keycloak on "),U=(0,a.Wm)("code",null,"https://diva.com/auth/",-1),K=(0,a.Uk)(", we set the variable as follows:"),I=(0,a.uE)('<div class="language-dotenv ext-dotenv"><pre class="language-dotenv"><code>KEYCLOAK_FRONTEND_URL=https://diva.com/auth/\n</code></pre></div><p>Below is the list of important variables:</p><div class="language-dotenv ext-dotenv"><pre class="language-dotenv"><code>KEYCLOAK_PORT=7000\nKEYCLOAK_USER=admin\nKEYCLOAK_PASSWORD=my_secure_password\nKEYCLOAK_DB_USER=keycloak\nKEYCLOAK_DB_PASSWORD=my_secure_password\n</code></pre></div><div class="custom-container danger"><p class="custom-container-title">Change credentials</p><p>Make sure to use secure Keycloak and Postgres usernames and passwords passed through the ENV&#39;s!</p></div><h3 id="realm"><a class="header-anchor" href="#realm">#</a> Realm</h3><p>The pre-configured realm is automatically loaded into DIVA Keycloak at startup and has a client for DIVA Web app. The default names for the realm and client are <code>diva-kc-realm</code> and <code>diva-kc-client</code>. This names are not mandatory and can be changed. You have only to reflect the name changes in the <a href="#web-client">Web Client configuration</a>.</p><p>To restrict access to the DIVA Keycloak, the redirect and origin URL&#39;s must be adjusted in the client. For this we have to navigate to Keycloak admin console on <code>https://diva.com/auth/admin/master/console/#/realms/diva-kc-realm</code> and under <strong>Clients</strong> -&gt; <code>diva-kc-client</code> -&gt; <strong>Settings</strong> set the <strong>Valid Redirect URIs</strong> and <strong>Web Origins</strong> options. These options must contain URL&#39;s under which the Web-client can be reached. For example if the client is deployed on <code>https://diva.com/</code>, we set the setting like follows:</p><ul><li>Valid Redirect URIs: <code>https://diva.com*</code></li><li>Web origins: <code>https://diva.com</code></li></ul>',8),_={class:"flex justify-center"},E=(0,a.uE)('<p>For the local development environment all values can be used as provided in the default configuration.</p><h3 id="authentication"><a class="header-anchor" href="#authentication">#</a> Authentication</h3><p>The Kong API Gateway uses JWT tokens issued by Keycloak to authenticate users for further access to the DIVA API. By default, we use tokens with RS256 signature algorithm with default expiration policies. The Web Client checks the token validity every <strong>60</strong> seconds.</p><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>If you change token settings in Keycloak, probably the adjustment in the API Gateway will be required. For more details refer to <a href="#kong-gateway">Kong configuration</a>.</p></div><h3 id="users-management"><a class="header-anchor" href="#users-management">#</a> Users management</h3><p>DIVA uses Keycloak <strong>only</strong> as identity management and log in service. That means all users date except <code>email</code> and <code>password</code> are still managed in DIVA. DIVA users have additional fields like <code>username</code>, <code>jobTitle</code>, <code>company</code> etc. and a profile image. All this data can be edited only in DIVA Web-client and the changes does not affect Keycloak users state.</p><p>The users from Keycloak are transferred to DIVA at login or register. Each time someone logs in or registers via Keycloak, the user data is updated in DIVA or a new user is created, if it does not yet exist in DIVA. This means that email and password can be updated in Keycloak, but only email and password.</p><div class="custom-container warning"><p class="custom-container-title">Users attributes</p><p>Please note that we only import the <strong>email</strong> of the keycloak user in DIVA. The changes of other users attributes in DIVA do not affect Keycloak and vice versa.</p></div><h2 id="kong-gateway"><a class="header-anchor" href="#kong-gateway">#</a> Kong Gateway</h2>',9),T=(0,a.Uk)("The "),V={href:"https://konghq.com/kong/",target:"_blank",rel:"noopener noreferrer"},D=(0,a.Uk)("Kong"),P=(0,a.Uk)(" API Gateway acts as a secure access point to the backend services. It is an abstraction layer for the REST API's of the individual services used by our "),x=(0,a.Wm)("a",{href:"#web-client"},"Web client",-1),R=(0,a.Uk)(". Gateway provides an authentication mechanism and accepts requests only from the clients with a valid "),L={href:"https://jwt.io/",target:"_blank",rel:"noopener noreferrer"},C=(0,a.Uk)("JWT"),O=(0,a.Uk)(". So the gateway is the security layer in the entire system and should be the only component accessible on the Internet. The backend of the system should always run behind the gateway, since the services themselves do not implement any authentication."),S=(0,a.Wm)("p",null,"As of DIVA v2.2 we use Keycloak as identity provider and user authorization service. The client sends the JWT tokens created by Keycloak in each request. Kong uses the token to authenticate the user by checking the token signature with the Keycloak public key.",-1),G=(0,a.Wm)("p",null,"This is the default flow for authorization and authentication by Keycloak and Kong, but it can be flexibly adjusted. If e.g. a different algorithm is used in Keycloak for token creation, Kong configuration must be adjusted accordingly so that Kong can correctly authenticate a user.",-1),j=(0,a.Wm)("h3",{id:"declarative-configuration"},[(0,a.Wm)("a",{class:"header-anchor",href:"#declarative-configuration"},"#"),(0,a.Uk)(" Declarative Configuration")],-1),Y=(0,a.Uk)("The Kong Gateway upstream services are configured through the declarative "),N={href:"https://github.com/FraunhoferISST/diva/blob/master/core/kong-gateway/kong.yml",target:"_blank",rel:"noopener noreferrer"},F=(0,a.Wm)("code",null,"kong.yml",-1),q=(0,a.Uk)(". Here you can regulate access to the service and enable or disable authentication for some routes or methods. To understand the configuration, we recommend reading the documentation on Kong."),B=(0,a.Uk)("The "),z=(0,a.Wm)("code",null,"kong.yml",-1),H=(0,a.Uk)(" contains configuration that is in no way suitable for production environment and is only useful for local development. We strongly encourage you to create and use other rather appropriate declarative configuration. As a baseline we provide you with an example configuration in "),J={href:"https://github.com/FraunhoferISST/diva/blob/master/core/kong-gateway/kong.production.yml",target:"_blank",rel:"noopener noreferrer"},M=(0,a.Wm)("code",null,"kong.production.yml",-1),$=(0,a.Uk)("."),Q=(0,a.Wm)("div",{class:"custom-container danger"},[(0,a.Wm)("p",{class:"custom-container-title"},"Exposed credentials"),(0,a.Wm)("p",null,[(0,a.Uk)("All sensitive information in default "),(0,a.Wm)("code",null,"kong.yml"),(0,a.Uk)(" and "),(0,a.Wm)("code",null,"kong.production.yml"),(0,a.Uk)(" is exposed on GitHub. Make sure to not copy and paste any secrets or passwords from the default publicity visible configurations!")])],-1),X=(0,a.Uk)("When deploying with Docker, you can easily switch between configurations with the "),Z=(0,a.Wm)("code",null,"KONG_DECLARATIVE_CONFIG",-1),ee=(0,a.Uk)(" environment variable. Please read more in our "),te=(0,a.Uk)("Docker guide"),ne=(0,a.Uk)(" about environment variables. For example, you can place your configuration in "),ae=(0,a.Wm)("code",null,"core/kong-gateway/my-production-config.yml",-1),oe=(0,a.Uk)(" and set the ENV in your "),ie=(0,a.Wm)("code",null,".env",-1),re=(0,a.Uk)(" file:"),se=(0,a.uE)('<div class="language-dotenv ext-dotenv"><pre class="language-dotenv"><code>KONG_DECLARATIVE_CONFIG=my-production-config.yml\n</code></pre></div><p>The next important point is that Kong needs to know the Keycloak token issuer for authentication. The field <code>iss</code> in Keycloak generated token depends on how <a href="#keycloak">Keycloak is configured</a> and on which URL it lives. Fo example, if the Keycloak instance is located on <code>https://my.kc.domain.com</code>, you have to adjust the following everywhere authentication is required:</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">plugins</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jwt<span class="token punctuation">-</span>keycloak\n    <span class="token key atrule">config</span><span class="token punctuation">:</span>\n      <span class="token key atrule">allowed_iss</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;https://my.kc.domain.com/auth/realms/&lt;realm-name&gt;&quot;</span> <span class="token punctuation">]</span>\n</code></pre></div>',3),le=(0,a.Uk)("And again, "),ce=(0,a.Wm)("code",null,"realm-name",-1),de=(0,a.Uk)(" depends on how your Keycloak is configured to be used in DIVA. In the default configuration shipped with DIVA the realm name is "),ue=(0,a.Wm)("code",null,"diva-kc-realm",-1),he=(0,a.Uk)(". In general the "),me=(0,a.Wm)("code",null,"iss",-1),pe=(0,a.Uk)(" URL origin part should correspond to with "),ge=(0,a.Wm)("code",null,"KEYCLOAK_FRONTEND_URL",-1),ye=(0,a.Uk)(" ENV specified URL origin. The resulting URL is used from "),ke={href:"https://github.com/gbbirkisson/kong-plugin-jwt-keycloak",target:"_blank",rel:"noopener noreferrer"},fe=(0,a.Wm)("code",null,"kong-plugin-jwt-keycloak",-1),ve=(0,a.Uk)(" to fetch the Keycloak public key and authenticate the user. It is important to note, that if you change the JWT token creation in Keycloak (e.g. signature algorithm), the provided token authentication may fail and you have to fix it on your own in your "),we=(0,a.Wm)("code",null,"my-production-config.yml",-1),be=(0,a.Uk)(" or create an issue and request the changes."),We=(0,a.Wm)("h2",{id:"web-client"},[(0,a.Wm)("a",{class:"header-anchor",href:"#web-client"},"#"),(0,a.Uk)(" Web client")],-1),Ae=(0,a.Wm)("p",null,"DIVA is a complex system with many services and different interfaces that drive the core functionality of the system. Operating the system requires a solid understanding of the underlying architecture and the technologies used. To enable everyone to enjoy the benefits of data management with DIVA, we have implemented a web-based client application.",-1),Ue={class:"flex justify-center"},Ke=(0,a.uE)('<p>The client communicates with the backend through Kong API Gateway and requires the user to be authenticated with a valid JWT.</p><p>Once loaded, the client performs the identity check through Keycloak and initializes the user data in the browser, if user exists and is already logged in, or navigates to login page. There the authorization to the system is managed by <a href="#keycloak">Keycloak</a>.</p><p>For the web client, in order to be able to execute identity verification and access API Gateway, corresponding information should be configured. The app can be configured by several environment variables and is shipped from a containerized Nginx server over the internet to the browser. The communication on <code>localhost</code> is not possible anymore and you have at least to configure correct URL&#39;s where client can rich Keycloak and API Gateway instances.</p><div class="custom-container tip"><p class="custom-container-title">ENV&#39;s on runtime</p><p>Yes, you do not have to rebuild the web-client Docker image every time any of the ENV&#39;s changes. The environment variables are injected in the app source code on each container start. You can adjust all accepted ENV&#39;s at any time without the need to build own image, just restart the container!</p></div><p>In the following we will list and explain environment variables that can be configured in you <code>docker/.env</code> and are automatically injected on runtime:</p>',5),Ie=(0,a.Wm)("code",null,"VUE_APP_API_GATEWAY_URL",-1),_e=(0,a.Uk)("- the client must know how to reach the gateway and uses the "),Ee=(0,a.Wm)("code",null,"VUE_APP_API_GATEWAY_URL",-1),Te=(0,a.Uk)(" environment variable as the base URL. You can learn more about how to deploy web-client and the Gateway with reverse proxy in our "),Ve=(0,a.Uk)("Docker guide"),De=(0,a.Uk)("."),Pe=(0,a.Wm)("code",null,"VUE_APP_KEYCLOAK_URL",-1),xe=(0,a.Uk)(" - the client must also know how to reach the Keycloak instance for user authorization. Here applies the same, in production the variable must be set correctly so that the client can communicate with Keycloak. Probably you will have your own managed Keycloak instance running. If not, we give an example on how to deploy Keycloak behind reverse proxy in our "),Re=(0,a.Uk)("Docker guide"),Le=(0,a.Uk)("."),Ce=(0,a.Wm)("li",null,[(0,a.Wm)("p",null,[(0,a.Wm)("code",null,"VUE_APP_KEYCLOAK_REALM"),(0,a.Uk)(" - if you have your own managed Keycloak instance, you can specify the realm that the client should use for user authentication. We ship DIVA with already preconfigured Keycloak instance that you can adjust. Otherwise, the default value ca be left as is.")])],-1),Oe=(0,a.Wm)("li",null,[(0,a.Wm)("p",null,[(0,a.Wm)("code",null,"VUE_APP_KEYCLOAK_CLIENT_ID"),(0,a.Uk)(" - the "),(0,a.Wm)("code",null,"id"),(0,a.Uk)(" of the Keycloak client that regulates the permission for our web-client. No need to change this variable, if you use the Keycloak instance shipped with DIVA as is and do not have own managed Keycloak.")])],-1),Se=(0,a.Wm)("code",null,"VUE_APP_REGISTER_AVAILABLE",-1),Ge=(0,a.Uk)(),je=(0,a.Uk)(" - by default the Web Client login page provides a link to the register page on Keycloak. If you want to disable the registration in Keycloak, this link can be deactivated and hidden. Just set "),Ye=(0,a.Wm)("code",null,"VUE_APP_REGISTER_AVAILABLE",-1),Ne=(0,a.Uk)(" to "),Fe=(0,a.Wm)("code",null,"false",-1),qe=(0,a.Uk)(", empty string or let the variable empty. For example:"),Be=(0,a.Wm)("div",{class:"language-text ext-text"},[(0,a.Wm)("pre",{class:"language-text"},[(0,a.Wm)("code",null,"VUE_APP_REGISTER_AVAILABLE=false\n# or\nVUE_APP_REGISTER_AVAILABLE\n")])],-1),ze=(0,a.Wm)("code",null,"VUE_APP_DISABLE_PATCH",-1),He=(0,a.Uk)(),Je=(0,a.Uk)(" - in the environments with the specific security policies it is possible to disable PATCH requests. In this case all PATCH API requests will be mapped to POST. To disable PATCH requests the variable should be set to "),Me=(0,a.Wm)("code",null,"true",-1),$e=(0,a.Uk)(", e.g.:"),Qe=(0,a.Wm)("div",{class:"language-text ext-text"},[(0,a.Wm)("pre",{class:"language-text"},[(0,a.Wm)("code",null,"VUE_APP_DISABLE_PATCH=true\n")])],-1),Xe=(0,a.Uk)("You can read more about how to use environment variables in the "),Ze=(0,a.Uk)("Docker guide"),et=(0,a.Uk)(". Please note that for the client to successfully and securely connect to Keycloak in the production environment and authenticate in Kong, Kong and Keycloak must be configured correctly as well. At this point we refer the reader to the corresponding "),tt=(0,a.Wm)("a",{href:"#kong-gateway"},"Kong Gateway",-1),nt=(0,a.Uk)(" and "),at=(0,a.Wm)("a",{href:"#keycloak"},"Keycloak",-1),ot=(0,a.Uk)(" guides."),it={render:function(e,t){const n=(0,a.up)("OutboundLink"),it=(0,a.up)("RouterLink"),rt=(0,a.up)("Badge");return(0,a.wg)(),(0,a.j4)(a.HY,null,[o,i,r,s,l,(0,a.Wm)("p",null,[(0,a.Wm)("a",c,[d,(0,a.Wm)(n)]),u]),(0,a.Wm)("p",null,[h,(0,a.Wm)("a",m,[p,(0,a.Wm)(n)]),g,(0,a.Wm)(it,{to:"/deployment/docker.html"},{default:(0,a.w5)((()=>[y])),_:1}),k]),f,(0,a.Wm)("p",null,[v,(0,a.Wm)(it,{to:"/deployment/docker.html#environment-variables"},{default:(0,a.w5)((()=>[w])),_:1}),b,W,A,U,K]),I,(0,a.Wm)("div",_,[(0,a.Wm)("img",{class:"rounded-lg",src:e.$withBase("/assets/keycloak_client.png"),alt:"Client configuration"},null,8,["src"])]),E,(0,a.Wm)("p",null,[T,(0,a.Wm)("a",V,[D,(0,a.Wm)(n)]),P,x,R,(0,a.Wm)("a",L,[C,(0,a.Wm)(n)]),O]),S,G,j,(0,a.Wm)("p",null,[Y,(0,a.Wm)("a",N,[F,(0,a.Wm)(n)]),q]),(0,a.Wm)("p",null,[B,z,H,(0,a.Wm)("a",J,[M,(0,a.Wm)(n)]),$]),Q,(0,a.Wm)("p",null,[X,Z,ee,(0,a.Wm)(it,{to:"/deployment/docker.html#environment-variables"},{default:(0,a.w5)((()=>[te])),_:1}),ne,ae,oe,ie,re]),se,(0,a.Wm)("p",null,[le,ce,de,ue,he,me,pe,ge,ye,(0,a.Wm)("a",ke,[fe,(0,a.Wm)(n)]),ve,we,be]),We,Ae,(0,a.Wm)("div",Ue,[(0,a.Wm)("img",{src:e.$withBase("/assets/diva_client.png"),height:"500",alt:"DIVA Architecture"},null,8,["src"])]),Ke,(0,a.Wm)("ul",null,[(0,a.Wm)("li",null,[(0,a.Wm)("p",null,[Ie,_e,Ee,Te,(0,a.Wm)(it,{to:"/deployment/docker.html#deployment-with-nginx-reverse-proxy"},{default:(0,a.w5)((()=>[Ve])),_:1}),De])]),(0,a.Wm)("li",null,[(0,a.Wm)("p",null,[Pe,xe,(0,a.Wm)(it,{to:"/deployment/docker.html#deployment-with-nginx-reverse-proxy"},{default:(0,a.w5)((()=>[Re])),_:1}),Le])]),Ce,Oe,(0,a.Wm)("li",null,[(0,a.Wm)("p",null,[Se,Ge,(0,a.Wm)(rt,{type:"tip",text:"v3",vertical:"middle"}),je,Ye,Ne,Fe,qe]),Be]),(0,a.Wm)("li",null,[(0,a.Wm)("p",null,[ze,He,(0,a.Wm)(rt,{type:"tip",text:"v3.3.1",vertical:"middle"}),Je,Me,$e]),Qe])]),(0,a.Wm)("p",null,[Xe,(0,a.Wm)(it,{to:"/deployment/docker.html#environment-variables"},{default:(0,a.w5)((()=>[Ze])),_:1}),et,tt,nt,at,ot])],64)}}}}]);