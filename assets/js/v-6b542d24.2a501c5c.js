(self.webpackChunkdiva_docs=self.webpackChunkdiva_docs||[]).push([[586],{8926:(e,t,n)=>{"use strict";n.r(t),n.d(t,{data:()=>a});const a={key:"v-6b542d24",path:"/development/architecture/gateway.html",title:"Gateway",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"Authentication",slug:"authentication",children:[]},{level:2,title:"Configuration",slug:"configuration",children:[]}],filePathRelative:"development/architecture/gateway.md",git:{contributors:[]}}},8819:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>ae});var a=n(6252);const o=(0,a.Wm)("h1",{id:"gateway"},[(0,a.Wm)("a",{class:"header-anchor",href:"#gateway"},"#"),(0,a.Uk)(" Gateway")],-1),i=(0,a.Uk)("The "),r={href:"https://konghq.com/kong/",target:"_blank",rel:"noopener noreferrer"},s=(0,a.Uk)("Kong"),l=(0,a.Uk)(" API Gateway acts as a secure access point to the backend services. It is an abstraction layer for the "),c=(0,a.Uk)("REST API's"),u=(0,a.Uk)(" of the individual services used by our "),h=(0,a.Uk)("Web client"),d=(0,a.Uk)(". Gateway provides an authentication mechanism and accepts requests only from the clients with a valid "),p={href:"https://jwt.io/",target:"_blank",rel:"noopener noreferrer"},m=(0,a.Uk)("JWT"),k=(0,a.Uk)(". So the gateway is the only security layer in the entire system and should be the only component accessible on the Internet. The backend of the system should always run behind the gateway, since the services themselves do not implement any authentication."),g=(0,a.uE)('<h2 id="authentication"><a class="header-anchor" href="#authentication">#</a> Authentication</h2><p>To reach the API behind the gateway, clients must include the Authorization Bearer header in the request:</p><div class="language-text ext-text"><pre class="language-text"><code>Authorization: Bearer &lt;JWT&gt;\n</code></pre></div><p>As of DIVA v2.2 we use Keycloak as identity provider and user authorization service. The client sends the JWT tokens created by Keycloak in each request and Kong in the header. Kong uses the token to authenticate the user by checking the token signature with the Keycloak public key.</p><p>When Kong processes requests, we use a plugin to extract user information from the token in authorization header and set it as additional headers. For example, the user <code>id</code> is extracted from the JWT and set as <code>x-actorid</code>. The <code>x-actorid</code> header is required by most services through the OpenAPI specification.</p><p>This is the default flow for authorization and authentication by Keycloak and Kong, but it can be flexibly adjusted. If a different algorithm is used in Keycloak for token creation, Kong configuration must be adjusted accordingly so that Kong can correctly authenticate a user.</p><h2 id="configuration"><a class="header-anchor" href="#configuration">#</a> Configuration</h2>',7),y=(0,a.Uk)("The Kong Gateway upstream service are configured through the declarative "),f={href:"https://github.com/FraunhoferISST/diva/blob/master/core/kong-gateway/kong.yml",target:"_blank",rel:"noopener noreferrer"},v=(0,a.Wm)("code",null,"kong.yml",-1),w=(0,a.Uk)(". Here you can regulate access to the service and enable or disable authentication for some routes or methods. To understand the configuration, we recommend reading the documentation on Kong."),b=(0,a.Uk)("The "),W=(0,a.Wm)("code",null,"kong.yml",-1),U=(0,a.Uk)(" contains configuration that is in no way suitable for production environment and is only useful for local development. As a baseline we provide an example production configuration in "),K={href:"https://github.com/FraunhoferISST/diva/blob/master/core/kong-gateway/kong.production.yml",target:"_blank",rel:"noopener noreferrer"},T=(0,a.Wm)("code",null,"kong.production.yml",-1),A=(0,a.Uk)(", which must always be kept up to date with the development configuration."),I=(0,a.Uk)("When deploying with Docker, you can easily switch between configurations with the "),_=(0,a.Wm)("code",null,"KONG_DECLARATIVE_CONFIG",-1),x=(0,a.Uk)(" environment variable. Please read more in our "),E=(0,a.Uk)("Docker guide"),R=(0,a.Uk)(" about environment variables. For example, you can place your configuration in "),L=(0,a.Wm)("code",null,"core/kong-gateway/my-production-config.yml",-1),j=(0,a.Uk)(" and set the ENV in your "),q=(0,a.Wm)("code",null,".env",-1),C=(0,a.Uk)(" file:"),G=(0,a.Wm)("div",{class:"language-dotenv ext-dotenv"},[(0,a.Wm)("pre",{class:"language-dotenv"},[(0,a.Wm)("code",null,"KONG_DECLARATIVE_CONFIG=my-production-config.yml\n")])],-1),D=(0,a.Uk)("The next important point is that Kong needs to know the Keycloak token issuer for authentication. The field "),F=(0,a.Wm)("code",null,"iss",-1),N=(0,a.Uk)(" in Keycloak generated token depends on how "),O=(0,a.Uk)("Keycloak is configured"),S=(0,a.Uk)(" and on which URL it lives. Fo example, if the Keycloak instance is located on "),V=(0,a.Wm)("code",null,"https://my.kc.domain.com",-1),P=(0,a.Uk)(", you have to adjust the following everywhere authentication is required:"),z=(0,a.uE)('<div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">plugins</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jwt<span class="token punctuation">-</span>keycloak\n    <span class="token key atrule">config</span><span class="token punctuation">:</span>\n      <span class="token key atrule">allowed_iss</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;https://my.kc.domain.com/auth/realms/&lt;realm-name&gt;&quot;</span> <span class="token punctuation">]</span>\n</code></pre></div>',1),J=(0,a.Uk)("And again, "),B=(0,a.Wm)("code",null,"realm-name",-1),H=(0,a.Uk)(" can very depending on how your Keycloak is configured to be used in DIVA. In the default configuration shipped with DIVA the realm name is "),Y=(0,a.Wm)("code",null,"diva-kc-realm",-1),M=(0,a.Uk)(". In general the "),Q=(0,a.Wm)("code",null,"iss",-1),X=(0,a.Uk)(" URL origin part should correspond to with "),Z=(0,a.Wm)("code",null,"KEYCLOAK_FRONTEND_URL",-1),$=(0,a.Uk)(" ENV specified URL origin. The resulting URL is used from "),ee={href:"https://github.com/gbbirkisson/kong-plugin-jwt-keycloak",target:"_blank",rel:"noopener noreferrer"},te=(0,a.Wm)("code",null,"kong-plugin-jwt-keycloak",-1),ne=(0,a.Uk)(" to fetch the Keycloak public key and authenticate the user. It is important to note, that if you change the JWT token creation in Keycloak (e.g. signature algorithm), the provided token authentication may fail and you have to adjust the declarative configuration correspondingly."),ae={render:function(e,t){const n=(0,a.up)("OutboundLink"),ae=(0,a.up)("RouterLink");return(0,a.wg)(),(0,a.j4)(a.HY,null,[o,(0,a.Wm)("p",null,[i,(0,a.Wm)("a",r,[s,(0,a.Wm)(n)]),l,(0,a.Wm)(ae,{to:"/development/architecture/rest-api.html"},{default:(0,a.w5)((()=>[c])),_:1}),u,(0,a.Wm)(ae,{to:"/development/architecture/web-client.html"},{default:(0,a.w5)((()=>[h])),_:1}),d,(0,a.Wm)("a",p,[m,(0,a.Wm)(n)]),k]),g,(0,a.Wm)("p",null,[y,(0,a.Wm)("a",f,[v,(0,a.Wm)(n)]),w]),(0,a.Wm)("p",null,[b,W,U,(0,a.Wm)("a",K,[T,(0,a.Wm)(n)]),A]),(0,a.Wm)("p",null,[I,_,x,(0,a.Wm)(ae,{to:"/development/deployment/docker.html#environment-variables"},{default:(0,a.w5)((()=>[E])),_:1}),R,L,j,q,C]),G,(0,a.Wm)("p",null,[D,F,N,(0,a.Wm)(ae,{to:"/development/architecture/keycloak.html"},{default:(0,a.w5)((()=>[O])),_:1}),S,V,P]),z,(0,a.Wm)("p",null,[J,B,H,Y,M,Q,X,Z,$,(0,a.Wm)("a",ee,[te,(0,a.Wm)(n)]),ne])],64)}}}}]);