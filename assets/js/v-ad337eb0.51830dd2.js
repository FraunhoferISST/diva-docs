(self.webpackChunkdiva_docs=self.webpackChunkdiva_docs||[]).push([[154],{7143:(e,n,o)=>{"use strict";o.r(n),o.d(n,{data:()=>t});const t={key:"v-ad337eb0",path:"/deployment/docker.html",title:"Docker deployment",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"Environment variables",slug:"environment-variables",children:[]},{level:2,title:"Deployment with nginx reverse proxy",slug:"deployment-with-nginx-reverse-proxy",children:[]}],filePathRelative:"deployment/docker.md",git:{contributors:[]}}},2568:(e,n,o)=>{"use strict";o.r(n),o.d(n,{default:()=>be});var t=o(6252);const a=(0,t.Wm)("h1",{id:"docker-deployment"},[(0,t.Wm)("a",{class:"header-anchor",href:"#docker-deployment"},"#"),(0,t.Uk)(" Docker deployment")],-1),s=(0,t.Wm)("p",null,[(0,t.Uk)("DIVA is built with a focus on scalability, modularization and expandability using a microservice architecture. Our team relies on the latest technologies for container-based development and deployment of the system using Docker. All system components are containerized and have current images that are continuously built in the CI pipeline. In this guide we will learn how to get DIVA running with "),(0,t.Wm)("code",null,"docker-compose"),(0,t.Uk)(".")],-1),l={class:"custom-container tip"},i=(0,t.Wm)("p",{class:"custom-container-title"},"TIP",-1),c=(0,t.Uk)("Make sure to read the "),r=(0,t.Uk)("prerequisites"),p=(0,t.Uk)(" to know what you need to get started with Docker and Docker Compose. Also note that deployment with docker is not suitable for Production. Nonetheless, it is convenient for local development environment to quickly spin up most of the components like Kafka, Gateway and other services."),d=(0,t.Uk)("All things related to docker are located in the "),u={href:"https://github.com/FraunhoferISST/diva/blob/master/docker",target:"_blank",rel:"noopener noreferrer"},h=(0,t.Wm)("code",null,"docker/",-1),m=(0,t.Uk)(" directory. You can find this folder in the source code as well as in the release distribution. Here we have prepared a script which you can use to directly boot all components, with default environment setup. If you need a quick start, just execute the following commands:"),k=(0,t.uE)('<div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># navigate to docker/ directory</span>\n<span class="token builtin class-name">cd</span> docker\n<span class="token comment"># spin up the system</span>\n./up_core.sh\n</code></pre></div><p>The script starts all core services, profiling workflow engine, DSC and the web client application. It may take some time until all components are up and running. By default, the client should be available on <code>localhost:70</code>.</p><div class="custom-container danger"><p class="custom-container-title">Container credentials</p><p>Bei default containers start with dummy values for credentials (e.g. <code>admin admin</code> for MongoDB) what is completely fine for local development environment. If you plan to make DIVA available publicity through the deployment with Docker, make sure to change all sensitive data. Refer to the <a href="#environment-variables">Environment variables</a> section.</p></div><h2 id="environment-variables"><a class="header-anchor" href="#environment-variables">#</a> Environment variables</h2><p>First with the environment variables you have the possibility to propagate settings to the containers on run time. The ENV&#39;s are used to configure exposed ports, Kafka topics, database connections, credentials etc. This makes the deployment of containers more flexible and provides you a way to configure the environment without potential collisions with other software on your machines.</p><div class="custom-container warning"><p class="custom-container-title">Ports allocation</p><p>DIVA components allocate many default ports like 80, 3000 or 27017. To avoid potential conflicts on deployment, most of the allocated ports can be configured in <code>docker/.env</code> file.</p></div>',6),g=(0,t.Uk)("All available configuration possibilities are listed in the "),y={href:"https://github.com/FraunhoferISST/diva/blob/master/docker/.env.default",target:"_blank",rel:"noopener noreferrer"},f=(0,t.Wm)("code",null,"docker/.env.default",-1),v=(0,t.Uk)(" file. This ENV template is used by default to boot the system with "),w=(0,t.Wm)("code",null,"up_core.sh",-1),b=(0,t.Uk)(" script. To override default settings, create a "),W=(0,t.Wm)("code",null,".env",-1),x=(0,t.Uk)(" file in the "),U=(0,t.Wm)("code",null,"docker/",-1),_=(0,t.Uk)(" directory and copy the contents of "),A=(0,t.Wm)("code",null,".env.default",-1),I=(0,t.Uk)(" to it. There you can adjust the deployment, should change all passwords and usernames and e.g. change the port of the web application as follows:"),K=(0,t.Wm)("div",{class:"language-env ext-env"},[(0,t.Wm)("pre",{class:"language-env"},[(0,t.Wm)("code",null,"WEB_CLIENT_PORT=90\n")])],-1),P=(0,t.Uk)("In the development environment, the configuration in "),D=(0,t.Wm)("code",null,".env.default",-1),q=(0,t.Uk)(' and other templates are quite sufficient and must work immediately. However, in order to make DIVA "production-ready" in Docker, we need to do some tweaks. Just follow the configuration guides for '),E=(0,t.Uk)("Keycloak"),T=(0,t.Uk)(", "),V=(0,t.Uk)("API Gateway"),C=(0,t.Uk)(" and "),R=(0,t.Uk)("Web-Client"),L=(0,t.Uk)(", in that order."),S=(0,t.Wm)("h2",{id:"deployment-with-nginx-reverse-proxy"},[(0,t.Wm)("a",{class:"header-anchor",href:"#deployment-with-nginx-reverse-proxy"},"#"),(0,t.Uk)(" Deployment with nginx reverse proxy")],-1),Y=(0,t.Uk)("As mentioned earlier, docker is not optimal for production deployment. However, it could be useful to quickly deliver to the world a DIVA instance in an experimental environment. For this purpose, we provide an example reverse proxy configuration in "),G={href:"https://github.com/FraunhoferISST/diva/blob/master/docker/proxy/",target:"_blank",rel:"noopener noreferrer"},N=(0,t.Wm)("code",null,"docker/proxy/",-1),O=(0,t.Uk)(" that allows to easily expose DIVA with Docker Compose."),F=(0,t.Wm)("p",null,[(0,t.Uk)("This simple nginx reverse proxy configuration serves as an example of how Diva could be exposed to the world. The proxy configuration in "),(0,t.Wm)("code",null,"nginx.example.conf"),(0,t.Uk)(" is minimalistic and "),(0,t.Wm)("strong",null,"not"),(0,t.Uk)(" suitable for production!")],-1),j=(0,t.Uk)("In general, the "),B=(0,t.Uk)("Web client"),H=(0,t.Uk)(" application and the "),M=(0,t.Uk)("API Gateway"),z=(0,t.Uk)(" should be accessible through the network behind the proxy. In addition, the client needs a running "),J=(0,t.Uk)("Keycloak"),X=(0,t.Uk)(" instance, which does not necessarily have to be delivered by the same reverse proxy server. So the rule is that only 3 DIVA components must be accessible over the internet - Web Client, Kong Gateway and Keycloak. Furthermore, for the Web-Client app the access to API Gateway and Keycloak should be configured through the "),$=(0,t.Wm)("a",{href:"#environment-variables"},"environment variables",-1),Q=(0,t.Uk)(" on runtime."),Z=(0,t.uE)('<p>In the following we will go through an example configuration, which must give a rough idea of how DIVA could be delivered with a secured reverse proxy server. To make things look more realistic, we will not be working with <code>localhost</code>. We will simply imagine the domain name <code>diva.com</code> and map it to <code>localhost</code> in <code>/etc/hosts</code> on our machine:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1 localhost diva.com\n</code></pre></div>',2),ee=(0,t.uE)('<li>Place your SSL certificate and key in <code>./certs</code><blockquote><p>Use letsencrypt, openssl or other tool of your choice. Here is a command that can quickly generate the required keys for you:</p><div class="language-text ext-text"><pre class="language-text"><code>openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout private.key -out certificate.crt\n</code></pre></div></blockquote></li><li>Create <code>nginx.conf</code> in <code>proxy/</code> and copy the contents of <code>nginx.example.conf</code> to it <blockquote><p>In this file you can add more advanced configuration, e.g. caching. Please note that your have to update the client app ENV&#39;s according to the changes in the config you made! In the example configuration we instruct nginx to proxy to the underlying components like follows:</p><div class="language-nginx ext-nginx"><pre class="language-nginx"><code><span class="token comment"># API Gateaway should be accessable on https://diva.com/api/ endpoint</span>\n<span class="token keyword">location</span> <span class="token operator">/</span>api<span class="token operator">/</span> <span class="token punctuation">{</span>\n      <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>kong<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span><span class="token punctuation">;</span> <span class="token comment"># the requests are directed to the Kong API Gateaway container</span>\n  <span class="token punctuation">}</span>\n</code></pre></div><div class="language-nginx ext-nginx"><pre class="language-nginx"><code><span class="token comment"># Keyclocak should be accessable on https://diva.com/auth/</span>\n<span class="token keyword">location</span> <span class="token operator">/</span><span class="token keyword">auth</span><span class="token operator">/</span> <span class="token punctuation">{</span>\n      <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>keycloak<span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span><span class="token keyword">auth</span><span class="token operator">/</span><span class="token punctuation">;</span> <span class="token comment"># the requests are directed to the Keycloak container, it could also be a URL of your own Keycloak instance</span>\n  <span class="token punctuation">}</span>\n</code></pre></div><div class="language-nginx ext-nginx"><pre class="language-nginx"><code><span class="token comment"># And finally the client itself, all othe request on https://diva.com/ should go to the web app</span>\n<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>\n      <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>web<span class="token operator">-</span>client<span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</code></pre></div></blockquote></li><li>Create <code>.env</code> in <code>proxy/</code> and copy the contents from <code>.env.default</code> to it <blockquote><p>You can choose a port for the proxy server in <code>.env</code> as <code>PROXY_PORT</code> with default <code>443</code> value.</p></blockquote></li><li>Set Web-Client ENV&#39;s and restart container <blockquote><p>Update the <code>VUE_APP_API_GATEWAY_URL</code> and <code>VUE_APP_KEYCLOAK_URL</code> in <code>docker/.env</code> corresponding to your nginx configuration. Make sure the client can access all API endpoints and communicate with Keycloak. According to provided default configuration the variables should be set for example as <code>VUE_APP_API_GATEWAY_URL=https://diva/api/</code> and <code>VUE_APP_KEYCLOAK_URL=https://diva.com/auth/</code></p></blockquote></li><li>Set Keycloak ENV&#39;s and restart container (optional) <blockquote><p>This step is only applicable if you do not have your own managed Keycloak instance running. In that case you have to update in your <code>docker/.env</code>: <code>KEYCLOAK_FRONTEND_URL=https://diva.com/auth/</code>.</p></blockquote></li>',5),ne=(0,t.Uk)("Create Kong production config and restart container "),oe=(0,t.Wm)("p",null,[(0,t.Uk)("In "),(0,t.Wm)("code",null,"core/kong-gateway"),(0,t.Uk)(" you have to create production config (e.g. "),(0,t.Wm)("code",null,"kong.prod.yml"),(0,t.Uk)("). Your can copy the contents from "),(0,t.Wm)("code",null,"core/kong-gateway/kong.production.yml"),(0,t.Uk)(" to it, but have at least to set everywhere the correct Keycloak token issuer:")],-1),te=(0,t.Wm)("div",{class:"language-text ext-text"},[(0,t.Wm)("pre",{class:"language-text"},[(0,t.Wm)("code",null,'plugins:\n   - name: jwt-keycloak\n     config:\n       allowed_iss: [ "https://diva.com/auth/realms/my-realm" ]\n')])],-1),ae=(0,t.Uk)("For more details refer to "),se=(0,t.Uk)("Kong API Gateway configuration"),le=(0,t.Wm)("li",null,[(0,t.Uk)("Make sure DIVA Core is already running "),(0,t.Wm)("blockquote",null,[(0,t.Wm)("p",null,[(0,t.Uk)("You can spin up anything needed with "),(0,t.Wm)("code",null,"./up_core.sh"),(0,t.Uk)(" in "),(0,t.Wm)("code",null,"docker/")])])],-1),ie=(0,t.Wm)("li",null,[(0,t.Uk)("Run nginx proxy server in "),(0,t.Wm)("code",null,"proxy/"),(0,t.Uk)(" with:"),(0,t.Wm)("div",{class:"language-bash ext-sh"},[(0,t.Wm)("pre",{class:"language-bash"},[(0,t.Wm)("code",null,"docker-compose up -d\n")])])],-1),ce=(0,t.Wm)("p",null,[(0,t.Uk)("On your local machine with the default nginx config the Web client is available on "),(0,t.Wm)("code",null,"https://diva.com/"),(0,t.Uk)(". Now just visit the URL, log in to the application through Keycloak, and make sure... that the authentication does not work! You will probably see something like:")],-1),re={class:"flex justify-center"},pe=(0,t.Uk)("And this is fine. Since Kong and Keycloak are running in the container in Docker and we are working with "),de=(0,t.Wm)("code",null,"diva.com",-1),ue=(0,t.Uk)(" fake domain, which maps to "),he=(0,t.Wm)("code",null,"localhost",-1),me=(0,t.Uk)(", Kong cannot communicate with Keycloak for authentication. In the real production environment this wouldn't be an issue, as Keycloak would be running on a real URL. Make sure to take a look at "),ke=(0,t.Uk)("API Gateway"),ge=(0,t.Uk)(", "),ye=(0,t.Uk)("Keycloak"),fe=(0,t.Uk)(" and "),ve=(0,t.Uk)("Web-client"),we=(0,t.Uk)(" configurations to better prepare DIVA for production."),be={render:function(e,n){const o=(0,t.up)("RouterLink"),be=(0,t.up)("OutboundLink");return(0,t.wg)(),(0,t.j4)(t.HY,null,[a,s,(0,t.Wm)("div",l,[i,(0,t.Wm)("p",null,[c,(0,t.Wm)(o,{to:"/deployment/"},{default:(0,t.w5)((()=>[r])),_:1}),p])]),(0,t.Wm)("p",null,[d,(0,t.Wm)("a",u,[h,(0,t.Wm)(be)]),m]),k,(0,t.Wm)("p",null,[g,(0,t.Wm)("a",y,[f,(0,t.Wm)(be)]),v,w,b,W,x,U,_,A,I]),K,(0,t.Wm)("p",null,[P,D,q,(0,t.Wm)(o,{to:"/architecture/keycloak.html#configuration"},{default:(0,t.w5)((()=>[E])),_:1}),T,(0,t.Wm)(o,{to:"/architecture/gateway.html#configuration"},{default:(0,t.w5)((()=>[V])),_:1}),C,(0,t.Wm)(o,{to:"/architecture/web-client.html#configuration"},{default:(0,t.w5)((()=>[R])),_:1}),L]),S,(0,t.Wm)("p",null,[Y,(0,t.Wm)("a",G,[N,(0,t.Wm)(be)]),O]),F,(0,t.Wm)("p",null,[j,(0,t.Wm)(o,{to:"/architecture/web-client.html"},{default:(0,t.w5)((()=>[B])),_:1}),H,(0,t.Wm)(o,{to:"/architecture/gateway.html"},{default:(0,t.w5)((()=>[M])),_:1}),z,(0,t.Wm)(o,{to:"/architecture/keycloak.html"},{default:(0,t.w5)((()=>[J])),_:1}),X,$,Q]),Z,(0,t.Wm)("ol",null,[ee,(0,t.Wm)("li",null,[ne,(0,t.Wm)("blockquote",null,[oe,te,(0,t.Wm)("p",null,[ae,(0,t.Wm)(o,{to:"/architecture/gateway.html"},{default:(0,t.w5)((()=>[se])),_:1})])])]),le,ie]),ce,(0,t.Wm)("div",re,[(0,t.Wm)("img",{class:"rounded-lg",src:e.$withBase("/assets/proxy_client_error.png"),alt:"authentication error"},null,8,["src"])]),(0,t.Wm)("p",null,[pe,de,ue,he,me,(0,t.Wm)(o,{to:"/deployment/configuration.html#kong-gateway"},{default:(0,t.w5)((()=>[ke])),_:1}),ge,(0,t.Wm)(o,{to:"/deployment/configuration.html#keycloak"},{default:(0,t.w5)((()=>[ye])),_:1}),fe,(0,t.Wm)(o,{to:"/deployment/configuration.html#web-client"},{default:(0,t.w5)((()=>[ve])),_:1}),we])],64)}}}}]);